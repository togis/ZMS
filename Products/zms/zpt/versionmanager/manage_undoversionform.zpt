<!DOCTYPE html>
<html lang="en" tal:define="standard modules/Products.zms/standard">
<head tal:replace="structure python:here.zmi_html_head(here,request)">zmi_html_head</head>
<body tal:attributes="class python:here.zmi_body_class(id='undo')">
<header tal:replace="structure python:here.zmi_body_header(here,request)">zmi_body_header</header>
<div id="zmi-tab">
<tal:block tal:content="structure python:here.zmi_breadcrumbs(here,request)">zmi_breadcrumbs</tal:block>

<form class="form-horizontal card pt-4" 
	tal:define="
		level python:here.getLevel();
		obj_versions python:here.getObjVersions();">

<div class="container diff-container">
	<div class="row">
			<div class="col-sm-6">
				<select class="form-control version-nr mb-3"></select>
				<div class="preview original center"></div>
				<pre class="json original d-none"></pre>
			</div>
			<div class="col-sm-6">
				<select class="form-control version-nr"></select>
				<div class="preview changed d-none"></div>
				<div class="preview diff center"></div>
				<pre class="json changed d-none"></pre>
			</div>
		<div class="col-sm-12">
			<pre class="json diff"></pre>
		</div>
	</div>
</div><!-- .container -->

<script>

function diff(container, qualifier) 
{
	var diffContainer = qualifier+".diff";
	$(container).prettyTextDiff({
		cleanup:true,
		originalContainer:qualifier+".original",
		changedContainer:qualifier+".changed",
		diffContainer:diffContainer
	});
	var $diffContainer = $(diffContainer,container);
	var lines = $diffContainer.html().replace(/<span>/gi,'').replace(/<\/span>/gi,'').split("<br>");
	var show = [];
	var changed = false;
	for (var i = 0; i < lines.length; i++) {
		var line = lines[i];
		changed |= line.indexOf("<"+"del>")>=0 || line.indexOf("<ins>")>=0;
		if (changed) {
			show.push(i);
		}
		changed &= !(line.indexOf("<"+"/del>")>=0 || line.indexOf("</ins>")>=0);
	}
	var html = [];
	changed = false;
	for (var i = 0; i < lines.length; i++) {
		var line = lines[i];
		changed |= line.indexOf("<"+"del>")>=0 || line.indexOf("<"+"ins>")>=0;
		line = '<'+'span class="line-number'+(changed?' line-changed':'')+'">'+(i+1)+'</span> '+lines[i];
		if (!(show.contains(i-1) || show.contains(i) || show.contains(i+1))) {
			line = '<'+'span class="diff-unchanged d-none">'+line+'<'+'/span>';
		}
		else {
			line = line+'<'+'br/>';
		}
		html.push(line);
		changed &= !(line.indexOf("<"+"/del>")>=0 || line.indexOf("<"+"/ins>")>=0);
	}
	$diffContainer.html(html.join(""));
}

	$(function() {
		var href = $ZMI.getPhysicalPath();
		$.get($ZMI.get_rest_api_url(href)+"/get_tags",function(tags) {
			$(tags).each(x => $("select.version-nr").append("<option value=\""+tags[x]+"\">"+tags[x]+"</option>"));
			$("select.version-nr").change(function() {
				var tag = $(this).val();
				var $preview = $(".preview",$(this).parent());
				var $json = $(".json",$(this).parent());
				$preview.text($(this).val());
				$.get($ZMI.get_rest_api_url(href)+"/body_content",{tag:tag},function(html) {
					$preview.html(html);
					$.get($ZMI.get_rest_api_url(href)+"/get_tag",{tag:tag},function(json) {
						var str = JSON.stringify(json, null, 4);
						$json.text(str);
						//diff($(".diff-container"),".preview");
						diff($(".diff-container"),".json");
					});
				});
			}).change();
		});
	});
</script>


</form><!-- .form-horizontal -->
<!-- #zmi-tab -->


<style>
	del {
		color:#777!important;
		background-color:#F2DEDE!important;
		text-decoration:line-through;
	}
	ins {
		color: #3C763D!important;
		background-color: #DFF0D8!important;
		text-decoration:none;
	}
	table.diff > tbody > tr > th:first-child {
		min-width:10em;
	}
	tr.diff .original, 
	tr.diff .changed {
		display:none;
	}
	table.diff td, 
	table.diff th {
		vertical-align:top;
		padding:.5em;
	}
	table.diff .diff th {
		background-color: #F9F9F9;
	}
	hr {
		border-color:transparent;
	}
	.center .contentEditable {
		max-height:260px;
		overflow-y: scroll !important;
	}
	li.even.zmi-item .center {
		background: #EDF5FE !important;
	}
	
</style>

<footer tal:replace="structure python:here.zmi_body_footer(here,request)">zmi_body_footer</footer>
<script type="text/javascript" charset="UTF-8" src="/++resource++zms_/jquery/diff/diff_match_patch.js"></script>
<script type="text/javascript" charset="UTF-8" src="/++resource++zms_/jquery/diff/jquery.pretty-text-diff.min.js"></script>
</body>
</html>
