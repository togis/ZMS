<!DOCTYPE html>
<html lang="en" tal:define="standard modules/Products.zms/standard">
<head tal:replace="structure python:here.zmi_html_head(here,request)">zmi_html_head</head>
<body tal:attributes="class python:here.zmi_body_class(id='undo')">
<header tal:replace="structure python:here.zmi_body_header(here,request)">zmi_body_header</header>
<div id="zmi-tab">
<tal:block tal:content="structure python:here.zmi_breadcrumbs(here,request)">zmi_breadcrumbs</tal:block>

<form class="form-horizontal card pt-4" 
	tal:define="
		level python:here.getLevel();
		obj_versions python:here.getObjVersions();">

<div class="container diff-container">
	<div class="row">
			<div class="col-sm-6">
				<div class="input-group mb-3" title="original">
					<div class="input-group-prepend">
						<span class="form-control input-group-text alert-danger">Version</span>
					</div>
					<select class="form-control version-nr"></select>
				</div>
				<div class="original preview"></div>
				<pre class="original json d-none"></pre>
			</div>
			<div class="col-sm-6">
				<div class="input-group mb-3" title="changed">
					<div class="input-group-prepend">
						<span class="form-control input-group-text alert-success">Version</span>
					</div>
					<select class="form-control version-nr"></select>
					<div class="input-group-append">
						<button id="toggle_splitview" class="btn btn-secondary" 
							title="Show/Hide Splitview"
							onclick="toggle_view(this,'toggle_splitview');return false;">
							<i class="fas fa-eye"></i>
						</button>
						<button id="toggle_datatype" class="btn btn-secondary" 
							title="Switch JSON vs HTML-Preview"
							onclick="toggle_view(this,'toggle_datatype');return false;">
							<i class="fas fa-file-alt"></i>
						</button>
					</div>
				</div>
				<div class="changed preview"></div>
				<pre class="changed json d-none"></pre>
			</div>
		<div class="col-sm-12">
			<pre class="diff preview"></pre>
			<pre class="diff json d-none"></pre>
		</div>
	</div>
</div><!-- .container -->

<script>
//<!--

function toggle_view(btn,btn_func) {
	// Hide Splitview
	$('.diff-container .original, .diff-container .changed').addClass('d-none');
	// Set datatype to be shown
	let datatype = $('#toggle_datatype i').hasClass('fa-code')? 'json': 'preview';
	// Conditionally Show Splitview
	// A. On Button-Click #toggle_splitview
	if ( btn_func=='toggle_splitview' ) {
		if ( $('i',$(btn)).hasClass('fa-eye') ){
			$('i',$(btn)).removeClass('fa-eye').addClass('fa-eye-slash')
		} else {
			// Show Splitview for current Datatype
			$('i',$(btn)).removeClass('fa-eye-slash').addClass('fa-eye');
			if (datatype=='json') {
				$('.diff-container .col-sm-6 .json').removeClass('d-none');
			} else {
				$('.diff-container .col-sm-6 .preview').removeClass('d-none');
			}
		}
	}
	// B. On Button-Click #toggle_datatype
	if ( btn_func=='toggle_datatype' ) {
		$('.diff-container .diff').addClass('d-none');
		$('#toggle_splitview i').removeClass('fa-eye-slash').addClass('fa-eye');
		// Show Splitview for current Datatype
		if (datatype=='json') {
			// Switch to html preview
			$('i',$(btn)).removeClass('fa-code').addClass('fa-file-alt');
			$('.diff-container .preview').removeClass('d-none');
		} else {
			// Switch to JSON view
			$('i',$(btn)).removeClass('fa-file-alt').addClass('fa-code');
			$('.diff-container .json').removeClass('d-none');
		}
	}
}

function diff(container, qualifier) {
	var diffContainer = qualifier+".diff";
	$(container).prettyTextDiff({
		cleanup:true,
		originalContainer:qualifier+".original",
		changedContainer:qualifier+".changed",
		diffContainer:diffContainer
	});
	var $diffContainer = $(diffContainer,container);
	var lines = $diffContainer.html().replace(/<span>/gi,'').replace(/<\/span>/gi,'').split("<br>");
	var show = [];
	var changed = false;
	for (var i = 0; i < lines.length; i++) {
		var line = lines[i];
		changed |= line.indexOf("<"+"del>")>=0 || line.indexOf("<ins>")>=0;
		if (changed) {
			show.push(i);
		}
		changed &= !(line.indexOf("<"+"/del>")>=0 || line.indexOf("</ins>")>=0);
	}
	var html = [];
	changed = false;
	for (var i = 0; i < lines.length; i++) {
		var line = lines[i];
		changed |= line.indexOf("<"+"del>")>=0 || line.indexOf("<"+"ins>")>=0;
		line = '<'+'span class="line-number'+(changed?' line-changed':'')+'">'+(i+1)+'</span> '+lines[i];
		if (!(show.contains(i-1) || show.contains(i) || show.contains(i+1))) {
			line = '<'+'span class="diff-unchanged d-none">'+line+'<'+'/span>';
		}
		else {
			line = line+'<'+'br/>';
		}
		html.push(line);
		changed &= !(line.indexOf("<"+"/del>")>=0 || line.indexOf("<"+"/ins>")>=0);
	}
	$diffContainer.html(html.join(""));
}

	$(function() {
		var href = $ZMI.getPhysicalPath();
		$.get($ZMI.get_rest_api_url(href)+"/get_tags",function(tags) {
			$(tags).each(x => $("select.version-nr").append("<option value=\""+tags[x]+"\">"+tags[x]+"</option>"));
			$("select.version-nr").change(function() {
				let $this_col = $(this).parent().parent();
				let tag = $(this).val();
				let $preview = $(".preview",$this_col);
				let $json = $(".json",$this_col);
				$preview.text($(this).val());
				$.get($ZMI.get_rest_api_url(href)+"/body_content", {tag:tag}, function(html) {
					$preview.html(html);
					diff($('.diff-container'),'.preview');
				});
				$.get($ZMI.get_rest_api_url(href)+"/get_tag",{tag:tag},function(json) {
					var str = JSON.stringify(json, null, 4);
					$json.text(str);
					diff($('.diff-container'),'.json');
				});
			}).change();
		});
	});
//-->
</script>


</form><!-- .form-horizontal -->
<!-- #zmi-tab -->


<style>
	del {
		color:#777!important;
		background-color:#F2DEDE!important;
		text-decoration:line-through;
	}
	ins {
		color: #3C763D!important;
		background-color: #DFF0D8!important;
		text-decoration:none;
	}
	table.diff > tbody > tr > th:first-child {
		min-width:10em;
	}
	tr.diff .original, 
	tr.diff .changed {
		display:none;
	}
	table.diff td, 
	table.diff th {
		vertical-align:top;
		padding:.5em;
	}
	table.diff .diff th {
		background-color: #F9F9F9;
	}
	hr {
		border-color:transparent;
	}
	.center .contentEditable {
		max-height:260px;
		overflow-y: scroll !important;
	}
	li.even.zmi-item .center {
		background: #EDF5FE !important;
	}
	button#toggle_preview,
	button#toggle_datatype {
		width: 2.5rem;
	}
	.diff {
		background-color: aliceblue;
	}
	.diff span.d-none {
		display:block !important;
	}

</style>

<footer tal:replace="structure python:here.zmi_body_footer(here,request)">zmi_body_footer</footer>
<script type="text/javascript" charset="UTF-8" src="/++resource++zms_/jquery/diff/diff_match_patch.js"></script>
<script type="text/javascript" charset="UTF-8" src="/++resource++zms_/jquery/diff/jquery.pretty-text-diff.min.js"></script>
</body>
</html>
